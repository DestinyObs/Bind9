# Nginx Reverse Proxy Configuration for All Lab Services
# This config is standalone and independent of your DNS server location.
# Each server block proxies a lab domain to its backend service, with explicit comments for clarity.
# Place this file in /etc/nginx/nginx.conf or /etc/nginx/conf.d/ on your reverse proxy server.

http {
    # Upstream definitions for clarity and maintainability
    upstream grafana_backend { server 10.0.5.5:3000; }         # Grafana
    upstream prometheus_backend { server 10.0.5.4:9090; }      # Prometheus
    upstream pulse_backend { server 10.0.5.8:7655; }           # Pulse
    upstream wazuh_backend { server 40.10.10.10:5601; }        # Wazuh (adjust port as needed)
    upstream pfsense_backend { server 192.168.32.1:443; }      # pfSense (HTTPS)
    upstream prox1_backend { server 192.168.3.8:8006; }        # Proxmox node 1
    upstream prox2_backend { server 192.168.3.9:8006; }        # Proxmox node 2

    # Grafana - HTTP (redirect to HTTPS)
    server {
        listen 80;
        server_name grafana.cybacad.lab;
        return 301 https://$host$request_uri;
    }
    # Grafana - HTTPS
    server {
        listen 443 ssl;
        server_name grafana.cybacad.lab;
        ssl_certificate /etc/letsencrypt/live/grafana.cybacad.lab/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/grafana.cybacad.lab/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
        location / {
            proxy_pass http://grafana_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # Prometheus - HTTP (redirect to HTTPS)
    server {
        listen 80;
        server_name prometheus.cybacad.lab;
        return 301 https://$host$request_uri;
    }
    # Prometheus - HTTPS
    server {
        listen 443 ssl;
        server_name prometheus.cybacad.lab;
        ssl_certificate /etc/letsencrypt/live/prometheus.cybacad.lab/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/prometheus.cybacad.lab/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
        location / {
            proxy_pass http://prometheus_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # Pulse - HTTP (redirect to HTTPS)
    server {
        listen 80;
        server_name pulse.cybacad.lab;
        return 301 https://$host$request_uri;
    }
    # Pulse - HTTPS
    server {
        listen 443 ssl;
        server_name pulse.cybacad.lab;
        ssl_certificate /etc/letsencrypt/live/pulse.cybacad.lab/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/pulse.cybacad.lab/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
        location / {
            proxy_pass http://pulse_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # Wazuh - HTTP (redirect to HTTPS)
    server {
        listen 80;
        server_name wazuh.cybacad.lab;
        return 301 https://$host$request_uri;
    }
    # Wazuh - HTTPS
    server {
        listen 443 ssl;
        server_name wazuh.cybacad.lab;
        ssl_certificate /etc/letsencrypt/live/wazuh.cybacad.lab/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/wazuh.cybacad.lab/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
        location / {
            proxy_pass http://wazuh_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # pfSense - HTTP (redirect to HTTPS)
    server {
        listen 80;
        server_name pfsense.cybacad.lab;
        return 301 https://$host$request_uri;
    }
    # pfSense - HTTPS (backend is HTTPS, proxy_pass to https)
    server {
        listen 443 ssl;
        server_name pfsense.cybacad.lab;
        ssl_certificate /etc/letsencrypt/live/pfsense.cybacad.lab/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/pfsense.cybacad.lab/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
        location / {
            proxy_pass https://pfsense_backend;
            proxy_ssl_verify off; # pfSense uses self-signed certs by default
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # Proxmox node 1 - HTTP (redirect to HTTPS)
    server {
        listen 80;
        server_name prox1.cybacad.lab;
        return 301 https://$host$request_uri;
    }
    # Proxmox node 1 - HTTPS
    server {
        listen 443 ssl;
        server_name prox1.cybacad.lab;
        ssl_certificate /etc/letsencrypt/live/prox1.cybacad.lab/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/prox1.cybacad.lab/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
        location / {
            proxy_pass https://prox1_backend;
            proxy_ssl_verify off;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # Proxmox node 2 - HTTP (redirect to HTTPS)
    server {
        listen 80;
        server_name prox2.cybacad.lab;
        return 301 https://$host$request_uri;
    }
    # Proxmox node 2 - HTTPS
    server {
        listen 443 ssl;
        server_name prox2.cybacad.lab;
        ssl_certificate /etc/letsencrypt/live/prox2.cybacad.lab/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/prox2.cybacad.lab/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
        location / {
            proxy_pass https://prox2_backend;
            proxy_ssl_verify off;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # nodeexp1 (Node Exporter 1) - HTTP (redirect to HTTPS)
    server {
        listen 80;
        server_name nodeexp1.cybacad.lab;
        return 301 https://$host$request_uri;
    }
    # nodeexp1 (Node Exporter 1) - HTTPS
    server {
        listen 443 ssl;
        server_name nodeexp1.cybacad.lab;
        ssl_certificate /etc/letsencrypt/live/nodeexp1.cybacad.lab/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/nodeexp1.cybacad.lab/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
        location / {
            proxy_pass http://10.0.5.2:9100;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # nodeexp2 (Node Exporter 2) - HTTP (redirect to HTTPS)
    server {
        listen 80;
        server_name nodeexp2.cybacad.lab;
        return 301 https://$host$request_uri;
    }
    # nodeexp2 (Node Exporter 2) - HTTPS
    server {
        listen 443 ssl;
        server_name nodeexp2.cybacad.lab;
        ssl_certificate /etc/letsencrypt/live/nodeexp2.cybacad.lab/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/nodeexp2.cybacad.lab/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
        location / {
            proxy_pass http://10.0.5.3:9100;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # windows (if web admin is enabled) - HTTP (redirect to HTTPS)
    server {
        listen 80;
        server_name windows.cybacad.lab;
        return 301 https://$host$request_uri;
    }
    # windows (if web admin is enabled) - HTTPS
    server {
        listen 443 ssl;
        server_name windows.cybacad.lab;
        ssl_certificate /etc/letsencrypt/live/windows.cybacad.lab/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/windows.cybacad.lab/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
        location / {
            proxy_pass http://192.168.32.2:8080; # Update port if needed
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # Add more server blocks for each service as your environment grows
}

# HTTPS configuration (optional, for production)
# Add SSL certificates and listen 443 blocks for each domain as needed.
# See Nginx docs for SSL setup and security best practices.
